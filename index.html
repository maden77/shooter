<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cacing Arena: Pro Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { background: #000; overflow: hidden; touch-action: none; position: fixed; width: 100%; height: 100%; color: white; font-family: sans-serif; }
        canvas { display: block; background: #050510; }

        /* UI MENU */
        #ui-layer { position: absolute; inset: 0; z-index: 100; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.9); }
        .panel { background: #111; padding: 25px; border-radius: 20px; border: 2px solid #a855f7; width: 90%; max-width: 400px; text-align: center; }
        
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; background: #000; color: #fff; text-align: center; }
        .btn { width: 100%; padding: 12px; margin: 5px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; }
        .btn-play { background: #a855f7; }
        .btn-shop { background: #f59e0b; }
        .btn-join { background: #3b82f6; }

        /* HUD */
        #hud { position: absolute; top: 15px; left: 15px; z-index: 50; display: none; }
        .badge { background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; border: 1px solid #a855f7; display: inline-block; margin-right: 5px; }

        /* JOYSTICK */
        #joy-zone { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; z-index: 50; display: none; }
        .joy-base { width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid #a855f7; position: relative; }
        .joy-stick { width: 50px; height: 50px; background: #a855f7; border-radius: 50%; position: absolute; top: 35px; left: 35px; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 200; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <canvas id="game"></canvas>

    <div id="ui-layer">
        <div class="panel">
            <h1 style="color:#a855f7">üêç CACING ARENA</h1>
            <p id="my-id" style="font-size: 10px; color: #777; margin-bottom: 10px;">ID: Memuat...</p>
            <input type="text" id="nick" value="Jagoan" placeholder="Nickname">
            <button class="btn btn-play" onclick="Game.start(false)">MAIN SOLO</button>
            <div style="border-top: 1px solid #333; margin: 10px 0;"></div>
            <input type="text" id="target-id" placeholder="Masukkan ID Teman">
            <button class="btn btn-join" onclick="Game.start(true)">GABUNG MABAR</button>
            <button class="btn btn-shop" onclick="Shop.open()">TOKO SKIN</button>
            <p style="margin-top:10px; color: gold;">ü™ô <span id="menu-coin">0</span></p>
        </div>
    </div>

    <div id="shop-modal" class="modal">
        <div class="panel">
            <h2>üõí TOKO SKIN</h2>
            <div id="skin-list" style="margin: 20px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
            <button class="btn btn-play" onclick="Shop.close()">TUTUP</button>
        </div>
    </div>

    <div id="hud">
        <div class="badge">ü™ô <span id="coins">0</span></div>
        <div class="badge">üìè <span id="score">0</span></div>
    </div>

    <div id="joy-zone">
        <div class="joy-base"><div class="joy-stick" id="stick"></div></div>
    </div>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        // --- DATA & CONFIG ---
        const SKINS = [
            { id: 'purple', main: '#a855f7', sec: '#6b21a8', price: 0 },
            { id: 'green', main: '#22c55e', sec: '#166534', price: 100 },
            { id: 'blue', main: '#3b82f6', sec: '#1d4ed8', price: 200 },
            { id: 'gold', main: '#fbbf24', sec: '#92400e', price: 500 }
        ];

        let storage = {
            coins: parseInt(localStorage.getItem('c_coins')) || 0,
            owned: JSON.parse(localStorage.getItem('c_owned')) || ['purple'],
            active: localStorage.getItem('c_active') || 'purple'
        };

        let state = { active: false, player: null, foods: [], others: {}, bots: [], cam: {x:0, y:0}, isMulti: false };
        let net = { peer: null, conn: null };

        // --- SNAKE CLASS (INTERPOLATED FOR SMOOTHNESS) ---
        class Snake {
            constructor(x, y, name, skinId, isBot = false) {
                this.x = x; this.y = y; this.name = name;
                this.isBot = isBot;
                this.skin = SKINS.find(s => s.id === skinId) || SKINS[0];
                this.angle = 0;
                this.speed = 4;
                this.radius = 20;
                this.score = 0;
                this.segments = [];
                // Inisialisasi segmen rapat agar tidak renggang/bergelombang
                for(let i=0; i<30; i++) this.segments.push({x, y});
            }

            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;

                // Logika agar badan lurus: hanya tambahkan segmen baru jika jarak sudah cukup
                const head = this.segments[0];
                const dist = Math.hypot(this.x - head.x, this.y - head.y);
                
                if (dist > 5) { // Jarak antar segmen kecil agar terlihat padat (lurus)
                    this.segments.unshift({x: this.x, y: this.y});
                    const maxLen = 30 + Math.floor(this.score / 5);
                    if (this.segments.length > maxLen) this.segments.pop();
                }

                if(this.isBot) this.angle += (Math.random() - 0.5) * 0.2;
            }

            draw() {
                ctx.save();
                for (let i = this.segments.length - 1; i >= 0; i--) {
                    const s = this.segments[i];
                    ctx.fillStyle = (i % 6 < 3) ? this.skin.main : this.skin.sec;
                    ctx.beginPath();
                    ctx.arc(s.x - state.cam.x + canvas.width/2, s.y - state.cam.y + canvas.height/2, this.radius, 0, Math.PI*2);
                    ctx.fill();
                }
                // Nama
                ctx.fillStyle = "white"; ctx.textAlign = "center";
                ctx.fillText(this.name, this.x - state.cam.x + canvas.width/2, this.y - state.cam.y + canvas.height/2 - 35);
                ctx.restore();
            }
        }

        // --- GAME SYSTEM ---
        const Game = {
            start: function(mabar) {
                const nick = document.getElementById('nick').value || "User";
                state.player = new Snake(0, 0, nick, storage.active);
                state.active = true;
                state.isMulti = mabar;
                
                document.getElementById('ui-layer').classList.add('hidden');
                document.getElementById('hud').style.display = 'block';
                document.getElementById('joy-zone').style.display = 'block';

                if(mabar) {
                    const tid = document.getElementById('target-id').value;
                    if(tid) { net.conn = net.peer.connect(tid); this.setupConn(); }
                }

                // Makanan melimpah
                for(let i=0; i<150; i++) this.spawnFood();
                // Bot (tidak mematikan)
                for(let i=0; i<5; i++) state.bots.push(new Snake(Math.random()*500, Math.random()*500, "BOT", "purple", true));

                this.loop();
            },

            spawnFood: function() {
                const emojis = ['üçé','üçî','üçï','üç©','üçñ','üçó'];
                state.foods.push({
                    x: (Math.random()-0.5) * 5000, 
                    y: (Math.random()-0.5) * 5000, 
                    icon: emojis[Math.floor(Math.random()*emojis.length)]
                });
            },

            loop: function() {
                if(!state.active) return;
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                ctx.fillStyle = "#050510"; ctx.fillRect(0,0,canvas.width,canvas.height);

                state.cam.x += (state.player.x - state.cam.x) * 0.1;
                state.cam.y += (state.player.y - state.cam.y) * 0.1;

                // Gambar Makanan
                ctx.font = "20px Arial";
                state.foods.forEach((f, i) => {
                    ctx.fillText(f.icon, f.x - state.cam.x + canvas.width/2, f.y - state.cam.y + canvas.height/2);
                    if(Math.hypot(state.player.x - f.x, state.player.y - f.y) < 30) {
                        state.foods.splice(i, 1);
                        state.player.score += 5;
                        storage.coins += 1;
                        this.spawnFood();
                        document.getElementById('score').innerText = state.player.score;
                        document.getElementById('coins').innerText = storage.coins;
                    }
                });

                state.player.update();
                state.player.draw();
                state.bots.forEach(b => { b.update(); b.draw(); });

                // Multi player sync
                if(net.conn && net.conn.open) {
                    net.conn.send({x: state.player.x, y: state.player.y, segments: state.player.segments, nick: state.player.name, skin: state.player.skin});
                }

                // Draw Others
                for(let id in state.others) {
                    const o = state.others[id];
                    o.segments.forEach((s, i) => {
                        ctx.fillStyle = (i % 6 < 3) ? o.skin.main : o.skin.sec;
                        ctx.beginPath();
                        ctx.arc(s.x - state.cam.x + canvas.width/2, s.y - state.cam.y + canvas.height/2, 20, 0, 6.28);
                        ctx.fill();
                    });
                }

                requestAnimationFrame(() => this.loop());
            },

            setupConn: function() {
                net.conn.on('data', data => { state.others[net.conn.peer] = data; });
            }
        };

        // --- TOKO ---
        const Shop = {
            open: function() {
                const list = document.getElementById('skin-list');
                list.innerHTML = '';
                SKINS.forEach(s => {
                    const owned = storage.owned.includes(s.id);
                    list.innerHTML += `
                        <div style="background:#222; padding:10px; border-radius:10px; border:2px solid ${storage.active==s.id?'#a855f7':'transparent'}" onclick="Shop.buy('${s.id}')">
                            <div style="background:${s.main}; height:20px; border-radius:5px;"></div>
                            <p style="font-size:12px; margin:5px 0;">${owned?'MILIK':'ü™ô'+s.price}</p>
                        </div>`;
                });
                document.getElementById('shop-modal').style.display = 'flex';
                document.getElementById('menu-coin').innerText = storage.coins;
            },
            buy: function(id) {
                const s = SKINS.find(x => x.id === id);
                if(storage.owned.includes(id)) { storage.active = id; }
                else if(storage.coins >= s.price) {
                    storage.coins -= s.price; storage.owned.push(id); storage.active = id;
                }
                localStorage.setItem('c_coins', storage.coins);
                localStorage.setItem('c_owned', JSON.stringify(storage.owned));
                localStorage.setItem('c_active', storage.active);
                this.open();
            },
            close: function() { document.getElementById('shop-modal').style.display = 'none'; }
        };

        // --- PEER JS (MABAR) ---
        net.peer = new Peer();
        net.peer.on('open', id => document.getElementById('my-id').innerText = "ID Kamu: " + id);
        net.peer.on('connection', c => { net.conn = c; Game.setupConn(); });

        // --- JOYSTICK ---
        const joy = document.getElementById('joy-zone');
        const stick = document.getElementById('stick');
        let start = {x:0, y:0}, dragging = false;
        const handleJoy = (e) => {
            if(!dragging) return;
            const p = e.touches ? e.touches[0] : e;
            const dx = p.clientX - start.x;
            const dy = p.clientY - start.y;
            state.player.angle = Math.atan2(dy, dx);
            const dist = Math.min(Math.hypot(dx,dy), 35);
            stick.style.transform = `translate(${Math.cos(state.player.angle)*dist}px, ${Math.sin(state.player.angle)*dist}px)`;
        };
        joy.addEventListener('touchstart', e => { dragging=true; start={x:e.touches[0].clientX, y:e.touches[0].clientY}; });
        window.addEventListener('touchmove', handleJoy);
        window.addEventListener('touchend', () => { dragging=false; stick.style.transform = 'none'; });

        window.onload = () => { document.getElementById('menu-coin').innerText = storage.coins; };
    </script>
</body>
</html>
