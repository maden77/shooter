<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cacing Arena Ultimate: Food & Shop</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; font-family: 'Segoe UI', sans-serif; }
        body { background: #000; overflow: hidden; touch-action: none; position: fixed; width: 100%; height: 100%; color: white; }
        canvas { display: block; background: radial-gradient(circle, #0a0a2a 0%, #000 100%); }

        /* UI LAYER */
        #ui-layer { position: absolute; inset: 0; z-index: 100; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.85); }
        .panel { background: #111; padding: 25px; border-radius: 20px; border: 3px solid #a855f7; width: 90%; max-width: 400px; text-align: center; }
        
        .btn { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-play { background: #a855f7; }
        .btn-shop { background: #f59e0b; }
        
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; background: #000; color: #fff; text-align: center; }

        /* HUD */
        #hud { position: absolute; top: 15px; left: 15px; z-index: 50; display: none; }
        .badge { background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; border: 1px solid #a855f7; display: inline-block; margin-right: 5px; font-weight: bold; }

        /* SHOP MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 200; padding: 20px; }
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; max-height: 300px; overflow-y: auto; }
        .item { background: #222; padding: 10px; border-radius: 10px; border: 2px solid transparent; cursor: pointer; }
        .item.active { border-color: #a855f7; }

        /* JOYSTICK */
        #joy-zone { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; z-index: 50; display: none; }
        .joy-base { width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid #a855f7; position: relative; }
        .joy-stick { width: 50px; height: 50px; background: #a855f7; border-radius: 50%; position: absolute; top: 35px; left: 35px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <canvas id="game"></canvas>

    <div id="ui-layer">
        <div class="panel">
            <h1 style="color:#a855f7; margin-bottom:15px;">üêç CACING ARENA</h1>
            <input type="text" id="nick" value="Jagoan" maxlength="10">
            <button class="btn btn-play" onclick="Game.start()">MAIN SOLO</button>
            <button class="btn btn-shop" onclick="Shop.open()">TOKO SKIN</button>
            <p id="menu-coins" style="margin-top:10px; color:#ffd700;">ü™ô 0</p>
        </div>
    </div>

    <div id="shop-modal" class="modal">
        <div class="panel">
            <h2>üõí TOKO SKIN</h2>
            <div id="skin-list" class="shop-grid"></div>
            <button class="btn btn-play" onclick="Shop.close()">TUTUP</button>
        </div>
    </div>

    <div id="hud">
        <div class="badge">üìè <span id="score">0</span></div>
        <div class="badge">ü™ô <span id="coins">0</span></div>
    </div>

    <div id="joy-zone">
        <div class="joy-base"><div class="joy-stick" id="stick"></div></div>
    </div>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        // --- DATA ---
        const EMOJIS = ['üçñ', 'üçî', 'üçï', 'üç©', 'üçé', 'üçì', 'üåÆ'];
        const SKINS = [
            { id: 'purple', name: 'Ungu', main: '#a855f7', sec: '#6b21a8', price: 0 },
            { id: 'green', name: 'Hijau', main: '#22c55e', sec: '#166534', price: 100 },
            { id: 'red', name: 'Merah', main: '#ef4444', sec: '#991b1b', price: 250 },
            { id: 'gold', name: 'Emas', main: '#fbbf24', sec: '#92400e', price: 1000 }
        ];

        let storage = {
            coins: parseInt(localStorage.getItem('c_coins')) || 0,
            owned: JSON.parse(localStorage.getItem('c_owned')) || ['purple'],
            active: localStorage.getItem('c_active') || 'purple'
        };

        let state = { active: false, player: null, bots: [], foods: [], cam: {x:0, y:0} };

        // --- CLASS CACING ---
        class Snake {
            constructor(x, y, name, skinId, isBot = false) {
                this.x = x; this.y = y; this.name = name;
                this.isBot = isBot;
                this.skin = SKINS.find(s => s.id === skinId) || SKINS[0];
                this.angle = Math.random() * 6.28;
                this.speed = isBot ? 2.5 : 4;
                this.radius = 20;
                this.score = 0;
                this.segments = [];
                for(let i=0; i<20; i++) this.segments.push({x, y});
            }

            update() {
                if (this.isBot) this.updateAI();
                
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;

                this.segments.unshift({x: this.x, y: this.y});
                if (this.segments.length > 20 + Math.floor(this.score/10)) this.segments.pop();

                if (this.isBot) this.magnet();
            }

            updateAI() {
                if (Math.random() < 0.02) this.angle += (Math.random() - 0.5);
                if (Math.abs(this.x) > 2000 || Math.abs(this.y) > 2000) this.angle += Math.PI;
            }

            magnet() {
                state.foods.forEach(f => {
                    let d = Math.hypot(this.x - f.x, this.y - f.y);
                    if (d < 150) { f.x += (this.x - f.x)*0.1; f.y += (this.y - f.y)*0.1; }
                });
            }

            draw() {
                for (let i = this.segments.length - 1; i >= 0; i--) {
                    let s = this.segments[i];
                    ctx.fillStyle = (i % 4 < 2) ? this.skin.main : this.skin.sec;
                    ctx.beginPath();
                    ctx.arc(s.x - state.cam.x + canvas.width/2, s.y - state.cam.y + canvas.height/2, this.radius, 0, 6.28);
                    ctx.fill();
                    ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.stroke();
                }
                // Nama
                ctx.fillStyle = "white"; ctx.font = "bold 14px Arial"; ctx.textAlign = "center";
                ctx.fillText(this.name, this.x - state.cam.x + canvas.width/2, this.y - state.cam.y + canvas.height/2 - 35);
            }
        }

        // --- GAME ENGINE ---
        const Game = {
            start: function() {
                document.getElementById('ui-layer').classList.add('hidden');
                document.getElementById('hud').style.display = 'block';
                document.getElementById('joy-zone').style.display = 'block';
                
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                const nick = document.getElementById('nick').value || "Jagoan";
                state.player = new Snake(0, 0, nick, storage.active);
                state.bots = []; state.foods = [];
                
                for(let i=0; i<6; i++) {
                    state.bots.push(new Snake((Math.random()-0.5)*2000, (Math.random()-0.5)*2000, "BOT", "red", true));
                }
                for(let i=0; i<100; i++) this.spawnFood();

                state.active = true;
                this.loop();
            },

            spawnFood: function() {
                state.foods.push({
                    x: (Math.random()-0.5)*4000, y: (Math.random()-0.5)*4000,
                    icon: EMOJIS[Math.floor(Math.random()*EMOJIS.length)]
                });
            },

            loop: function() {
                if (!state.active) return;
                ctx.fillStyle = "#0a0a1a"; ctx.fillRect(0,0,canvas.width,canvas.height);

                state.cam.x += (state.player.x - state.cam.x) * 0.1;
                state.cam.y += (state.player.y - state.cam.y) * 0.1;

                // Makanan
                ctx.font = "24px Arial";
                state.foods.forEach((f, i) => {
                    let dx = f.x - state.cam.x + canvas.width/2;
                    let dy = f.y - state.cam.y + canvas.height/2;
                    ctx.fillText(f.icon, dx, dy);

                    if (Math.hypot(state.player.x - f.x, state.player.y - f.y) < 30) {
                        state.player.score += 10;
                        document.getElementById('score').innerText = state.player.score;
                        state.foods.splice(i, 1);
                        this.spawnFood();
                    }
                });

                // Update & Collision
                state.player.update();
                
                state.bots.forEach((b, bi) => {
                    b.update();
                    // Kita nabrak bot?
                    for(let seg of b.segments) {
                        if(Math.hypot(state.player.x - seg.x, state.player.y - seg.y) < 25) this.die();
                    }
                    // Bot nabrak kita?
                    for(let pseg of state.player.segments) {
                        if(Math.hypot(b.x - pseg.x, b.y - pseg.y) < 25) {
                            state.bots.splice(bi, 1);
                            storage.coins += 20; // Hadiah bunuh bot
                            this.save();
                            document.getElementById('coins').innerText = storage.coins;
                            state.bots.push(new Snake((Math.random()-0.5)*2000, (Math.random()-0.5)*2000, "BOT", "red", true));
                        }
                    }
                });

                state.bots.forEach(b => b.draw());
                state.player.draw();

                requestAnimationFrame(() => this.loop());
            },

            die: function() {
                state.active = false;
                alert("üíÄ MATI! Skor: " + state.player.score);
                location.reload();
            },

            save: function() {
                localStorage.setItem('c_coins', storage.coins);
                localStorage.setItem('c_owned', JSON.stringify(storage.owned));
                localStorage.setItem('c_active', storage.active);
            }
        };

        // --- SHOP SYSTEM ---
        const Shop = {
            open: function() {
                const list = document.getElementById('skin-list');
                list.innerHTML = '';
                SKINS.forEach(s => {
                    const isOwned = storage.owned.includes(s.id);
                    list.innerHTML += `
                        <div class="item ${storage.active === s.id ? 'active' : ''}" onclick="Shop.buy('${s.id}')">
                            <div style="background:${s.main}; height:20px; border-radius:10px;"></div>
                            <p>${s.name}</p>
                            <p style="color:#ffd700">${isOwned ? 'MILIK' : 'ü™ô'+s.price}</p>
                        </div>
                    `;
                });
                document.getElementById('shop-modal').style.display = 'flex';
                document.getElementById('menu-coins').innerText = "ü™ô " + storage.coins;
            },
            buy: function(id) {
                const s = SKINS.find(x => x.id === id);
                if (storage.owned.includes(id)) {
                    storage.active = id;
                } else if (storage.coins >= s.price) {
                    storage.coins -= s.price;
                    storage.owned.push(id);
                    storage.active = id;
                } else {
                    alert("Koin tidak cukup!");
                }
                Game.save();
                this.open();
            },
            close: function() { document.getElementById('shop-modal').style.display = 'none'; }
        };

        // --- JOYSTICK ---
        const Joy = {
            init: function() {
                const z = document.getElementById('joy-zone');
                const s = document.getElementById('stick');
                let dragging = false, start = {x:0, y:0};

                const move = e => {
                    if(!dragging || !state.player) return;
                    const p = e.touches ? e.touches[0] : e;
                    const dx = p.clientX - start.x, dy = p.clientY - start.y;
                    state.player.angle = Math.atan2(dy, dx);
                    const dist = Math.min(Math.hypot(dx,dy), 35);
                    s.style.transform = `translate(${Math.cos(state.player.angle)*dist}px, ${Math.sin(state.player.angle)*dist}px)`;
                };

                z.onmousedown = e => { dragging=true; start={x:e.clientX, y:e.clientY}; };
                z.ontouchstart = e => { dragging=true; start={x:e.touches[0].clientX, y:e.touches[0].clientY}; };
                window.onmousemove = move; window.ontouchmove = move;
                window.onmouseup = window.ontouchend = () => { dragging=false; s.style.transform='none'; };
            }
        };

        window.onload = () => {
            document.getElementById('menu-coins').innerText = "ü™ô " + storage.coins;
            Joy.init();
        };
    </script>
</body>
</html>
